import{r as g,s as L,k as j,_ as z,H as S,w as C,b as O,o as x,c as y,d as e,e as B,f as D,t as r,F as I,J as M,h as E,C as R,m as V,E as K}from"./index-06309a7e.js";import{c as $}from"./cacheManager-5937ebc8.js";const _={defaultPollInterval:3e4,maxPollInterval:3e5,minPollInterval:5e3,maxRetries:3,retryDelay:1e3,enableWebSocket:!1,wsReconnectInterval:5e3};class N{constructor(){this.pollingTasks=new Map,this.websocketConnections=new Map,this.subscribers=new Map,this.isInitialized=!1}init(){this.isInitialized||(this.isInitialized=!0,document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)))}createPollingTask(t,s,l={}){const{interval:i=_.defaultPollInterval,immediate:o=!0,onSuccess:h=null,onError:c=null,retryOnError:w=!0,cacheKey:u=null,cacheTTL:k=null}=l,T=Math.max(_.minPollInterval,Math.min(i,_.maxPollInterval)),d={key:t,fetcher:s,interval:T,timer:null,retryCount:0,isRunning:!1,onSuccess:h,onError:c,retryOnError:w,cacheKey:u,cacheTTL:k,lastUpdate:null};return this.pollingTasks.set(t,d),o&&this.startPolling(t),d}async startPolling(t){const s=this.pollingTasks.get(t);!s||s.isRunning||(s.isRunning=!0,await this.executePollingTask(s),s.timer=setInterval(async()=>{await this.executePollingTask(s)},s.interval))}stopPolling(t){const s=this.pollingTasks.get(t);s&&(s.timer&&(clearInterval(s.timer),s.timer=null),s.isRunning=!1)}async executePollingTask(t){try{const s=await t.fetcher();t.cacheKey&&$.set(t.cacheKey,s,t.cacheTTL),this.notifySubscribers(t.key,s),t.onSuccess&&t.onSuccess(s),t.lastUpdate=Date.now(),t.retryCount=0}catch(s){console.error(`轮询任务 ${t.key} 执行失败:`,s),t.onError&&t.onError(s),t.retryOnError&&t.retryCount<_.maxRetries&&(t.retryCount++,setTimeout(async()=>{await this.executePollingTask(t)},_.retryDelay*t.retryCount))}}subscribe(t,s){return this.subscribers.has(t)||this.subscribers.set(t,new Set),this.subscribers.get(t).add(s),()=>{const l=this.subscribers.get(t);l&&(l.delete(s),l.size===0&&this.subscribers.delete(t))}}notifySubscribers(t,s){const l=this.subscribers.get(t);l&&l.forEach(i=>{try{i(s)}catch(o){console.error("订阅回调执行失败:",o)}})}async triggerUpdate(t){const s=this.pollingTasks.get(t);s&&await this.executePollingTask(s)}updatePollingInterval(t,s){const l=this.pollingTasks.get(t);if(!l)return;const i=Math.max(_.minPollInterval,Math.min(s,_.maxPollInterval));l.interval!==i&&(l.interval=i,l.isRunning&&(this.stopPolling(t),this.startPolling(t)))}getTaskStatus(t){const s=this.pollingTasks.get(t);return s?{key:s.key,isRunning:s.isRunning,interval:s.interval,retryCount:s.retryCount,lastUpdate:s.lastUpdate,nextUpdate:s.lastUpdate?s.lastUpdate+s.interval:null}:null}getAllTaskStatus(){return Array.from(this.pollingTasks.keys()).map(t=>this.getTaskStatus(t))}handleVisibilityChange(){document.hidden?this.pauseAllPolling():this.resumeAllPolling()}handleOnline(){console.log("网络已连接，恢复实时更新"),this.resumeAllPolling()}handleOffline(){console.log("网络已断开，暂停实时更新"),this.pauseAllPolling()}pauseAllPolling(){this.pollingTasks.forEach((t,s)=>{t.isRunning&&this.stopPolling(s)})}resumeAllPolling(){this.pollingTasks.forEach((t,s)=>{t.isRunning||this.startPolling(s)})}destroy(){this.pollingTasks.forEach((t,s)=>{this.stopPolling(s)}),this.subscribers.clear(),document.removeEventListener("visibilitychange",this.handleVisibilityChange),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),this.isInitialized=!1}}const P=new N;function F(f,t,s={}){const l=g(null),i=g(!1),o=g(null),h=g(null),c=g(null),w=()=>{const d=P.createPollingTask(f,t,{...s,onSuccess:p=>{l.value=p,i.value=!1,o.value=null,h.value=Date.now()},onError:p=>{o.value=p,i.value=!1}});return c.value=P.subscribe(f,p=>{l.value=p,h.value=Date.now()}),d},u=()=>{P.stopPolling(f),c.value&&(c.value(),c.value=null)},k=()=>{P.triggerUpdate(f)},T=d=>{P.updatePollingInterval(f,d)};return L(()=>{P.init(),w()}),j(()=>{u()}),{data:l,loading:i,error:o,lastUpdate:h,startRealtime:w,stopRealtime:u,triggerUpdate:k,updateInterval:T}}const H={class:"fade-in"},J={class:"mb-6"},W={class:"flex justify-between items-center"},Z={class:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6"},q={class:"stat-card"},G={class:"flex justify-between items-start"},Q={class:"text-2xl font-semibold mt-1"},X={class:"stat-card"},Y={class:"flex justify-between items-start"},tt={class:"text-2xl font-semibold mt-1"},st={class:"stat-card"},et={class:"flex justify-between items-start"},nt={class:"text-2xl font-semibold mt-1"},at={class:"stat-card"},lt={class:"flex justify-between items-start"},it={class:"text-2xl font-semibold mt-1"},rt={key:0,class:"bg-white rounded-lg shadow-sm border border-gray-100 p-12"},ot={key:1},ct={class:"flex justify-between items-center mb-6"},ut={class:"font-medium text-lg"},dt={class:"flex gap-2"},gt={class:"px-2 py-1 bg-success/10 text-success rounded-full text-xs"},ft={class:"px-2 py-1 bg-warning/10 text-warning rounded-full text-xs"},ht={class:"px-2 py-1 bg-danger/10 text-danger rounded-full text-xs"},pt={class:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"},vt={class:"spot-header"},mt={class:"spot-number"},bt={class:"spot-info"},xt={class:"spot-type"},yt={class:"spot-zone"},_t={__name:"ParkingStatus",setup(f){const t=g([]),s=g(!0),l=g(["A","B","C"]),i=S(()=>{const a={A:[],B:[],C:[]};return t.value.forEach(n=>{a[n.zone]&&a[n.zone].push(n)}),a}),o=S(()=>t.value.length),h=S(()=>t.value.filter(a=>a.status==="空闲").length),c=S(()=>t.value.filter(a=>a.status==="已预约").length),w=S(()=>t.value.filter(a=>a.status==="已占用").length),u=a=>{const n=i.value[a]||[];return{available:n.filter(v=>v.status==="空闲").length,reserved:n.filter(v=>v.status==="已预约").length,occupied:n.filter(v=>v.status==="已占用").length}},k=a=>({空闲:"bg-success/10 text-success",已预约:"bg-warning/10 text-warning",已占用:"bg-danger/10 text-danger"})[a]||"bg-gray-100 text-gray-600",T=a=>({空闲:"spot-available",已预约:"spot-reserved",已占用:"spot-occupied"})[a]||"spot-default",d=async()=>{const a=localStorage.getItem("token"),n=await V.get("/api/parking-spots",{headers:{Authorization:`Bearer ${a}`},params:{per_page:20}});if(n.data.success)return n.data.data;throw new Error("获取车位信息失败")},{data:p,loading:U,error:A,lastUpdate:wt}=F("parking-status",d,{interval:3e4,cacheKey:"parking_status_data",cacheTTL:6e4});return C(p,a=>{a&&(t.value=a)}),C(U,a=>{s.value=a}),C(A,a=>{a&&K.error("获取车位信息失败，请稍后重试")}),(a,n)=>{const v=O("el-button");return x(),y("div",H,[e("div",J,[e("div",W,[n[2]||(n[2]=e("div",null,[e("h2",{class:"text-[clamp(1.25rem,3vw,1.75rem)] font-semibold"},"车位状态"),e("p",{class:"text-gray-500 mt-1"},"实时查看停车场各区域车位使用情况")],-1)),B(v,{type:"primary",onClick:n[0]||(n[0]=m=>a.$router.push("/user")),class:"back-btn"},{default:D(()=>n[1]||(n[1]=[e("i",{class:"fa fa-arrow-left mr-2"},null,-1),E(" 返回首页 ")])),_:1,__:[1]})])]),e("div",Z,[e("div",q,[e("div",G,[e("div",null,[n[3]||(n[3]=e("p",{class:"text-gray-500 text-sm"},"总车位",-1)),e("h3",Q,r(o.value),1)]),n[4]||(n[4]=e("div",{class:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary"},[e("i",{class:"fa fa-car"})],-1))])]),e("div",X,[e("div",Y,[e("div",null,[n[5]||(n[5]=e("p",{class:"text-gray-500 text-sm"},"空闲车位",-1)),e("h3",tt,r(h.value),1)]),n[6]||(n[6]=e("div",{class:"w-10 h-10 rounded-full bg-success/10 flex items-center justify-center text-success"},[e("i",{class:"fa fa-check-circle"})],-1))])]),e("div",st,[e("div",et,[e("div",null,[n[7]||(n[7]=e("p",{class:"text-gray-500 text-sm"},"已预约",-1)),e("h3",nt,r(c.value),1)]),n[8]||(n[8]=e("div",{class:"w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center text-warning"},[e("i",{class:"fa fa-clock-o"})],-1))])]),e("div",at,[e("div",lt,[e("div",null,[n[9]||(n[9]=e("p",{class:"text-gray-500 text-sm"},"已占用",-1)),e("h3",it,r(w.value),1)]),n[10]||(n[10]=e("div",{class:"w-10 h-10 rounded-full bg-danger/10 flex items-center justify-center text-danger"},[e("i",{class:"fa fa-ban"})],-1))])])]),s.value?(x(),y("div",rt,n[11]||(n[11]=[e("div",{class:"text-center"},[e("i",{class:"fa fa-spinner fa-spin text-4xl text-primary mb-4"}),e("p",{class:"text-gray-500"},"正在加载车位信息...")],-1)]))):(x(),y("div",ot,[(x(!0),y(I,null,M(l.value,m=>(x(),y("div",{key:m,class:"bg-white rounded-lg shadow-sm border border-gray-100 p-6 mb-6"},[e("div",ct,[e("h3",ut,r(m)+" 区车位状态",1),e("div",dt,[e("span",gt," 空闲: "+r(u(m).available),1),e("span",ft," 预约: "+r(u(m).reserved),1),e("span",ht," 占用: "+r(u(m).occupied),1)])]),e("div",pt,[(x(!0),y(I,null,M(i.value[m],b=>(x(),y("div",{key:b.id,class:R(["spot-card-modern",T(b.status)])},[e("div",vt,[e("div",mt,r(b.spot_number),1),e("div",{class:R(["spot-status-badge",k(b.status)])},r(b.status),3)]),e("div",bt,[e("div",xt,[n[12]||(n[12]=e("i",{class:"fa fa-car mr-1"},null,-1)),E(" "+r(b.type),1)]),e("div",yt,[n[13]||(n[13]=e("i",{class:"fa fa-map-marker mr-1"},null,-1)),E(" "+r(b.zone)+"区 ",1)])])],2))),128))])]))),128))]))])}}},Tt=z(_t,[["__scopeId","data-v-db607da9"]]);export{Tt as default};
