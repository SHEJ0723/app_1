import{u as K,r as c,a as L,w as N,b as m,o as P,c as x,d as u,e as a,f as i,g as q,h as g,F as A,i as Z,t as z,j as B,E as f}from"./index-06309a7e.js";import{a as C}from"./auth-6129cfe6.js";const M=(d,o,e)=>{o?/^1[3-9]\d{9}$/.test(o)?e():e(new Error("请输入正确的手机号格式")):e(new Error("请输入手机号"))},j=(d,o,e)=>{o?/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领][A-Z][A-Z0-9]{5,7}$/.test(o)?e():e(new Error("请输入正确的车牌号格式")):e(new Error("请输入车牌号"))},D=(d,o,e)=>{o?o.length<6?e(new Error("密码长度不能少于6位")):o.length>20?e(new Error("密码长度不能超过20位")):e():e(new Error("请输入密码"))},J=(d,o,e)=>{o?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)?e():e(new Error("请输入正确的邮箱格式")):e(new Error("请输入邮箱"))},O=(d,o,e)=>{o?o.length<3?e(new Error("用户名长度不能少于3位")):o.length>20?e(new Error("用户名长度不能超过20位")):/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(o)?e():e(new Error("用户名只能包含字母、数字、下划线和中文")):e(new Error("请输入用户名"))},W=(d,o,e)=>{o?/^[a-zA-Z0-9]{3,10}$/.test(o)?e():e(new Error("工号必须是3-10位字母或数字")):e(new Error("请输入工号"))},G=(d,o,e)=>{o?/^[a-zA-Z0-9]{4,6}$/.test(o)?e():e(new Error("验证码格式不正确")):e(new Error("请输入验证码"))},H=(d,o,e)=>{!o||o.length!==2?e(new Error("请选择时间范围")):o[1]<=o[0]?e(new Error("结束时间必须晚于开始时间")):e()},Q=(d,o,e)=>{o?/^\d+(\.\d{1,2})?$/.test(o)?parseFloat(o)<=0?e(new Error("金额必须大于0")):e():e(new Error("请输入正确的金额格式")):e(new Error("请输入金额"))},X=(d=5,o=500)=>(e,p,n)=>{p?p.length<d?n(new Error(`内容长度不能少于${d}个字符`)):p.length>o?n(new Error(`内容长度不能超过${o}个字符`)):n():n(new Error("请输入内容"))},I={phone:[{required:!0,validator:M,trigger:"blur"}],password:[{required:!0,validator:D,trigger:"blur"}],email:[{required:!0,validator:J,trigger:"blur"}],username:[{required:!0,validator:O,trigger:"blur"}],workId:[{required:!0,validator:W,trigger:"blur"}],captcha:[{required:!0,validator:G,trigger:"blur"}],plate:[{required:!0,validator:j,trigger:"blur"}],timeRange:[{required:!0,validator:H,trigger:"change"}],amount:[{required:!0,validator:Q,trigger:"blur"}],content:[{required:!0,validator:X(5,500),trigger:"blur"}]};const Y={class:"login-bg"},ee={class:"login-card"},re={class:"login-type-switch"},oe={class:"form-options"},te={class:"captcha-image-container"},se=["src"],ae={key:2,class:"register-link"},ie={__name:"Login",setup(d){const o=K(),e=c(null),p=c(!1),n=c("user"),w=c(""),_=c(0),v=c(null),t=L({phone:"",password:"",workId:"admin",adminPassword:"admin123",captcha:"",remember:!1}),k=L({phone:I.phone,password:I.password,workId:I.workId,adminPassword:I.password,captcha:I.captcha}),U=async()=>{try{v.value&&clearInterval(v.value),t.captcha="",w.value="";const s=await C.getCaptcha();s.success&&(w.value=s.data.image,_.value=s.data.expires_in,console.log("验证码获取成功，session_id应该已设置到cookie中"),v.value=setInterval(()=>{_.value--,_.value<=0&&(clearInterval(v.value),w.value="",f.warning("验证码已过期，请点击图片重新获取"))},1e3))}catch(s){console.error("获取验证码失败:",s),f.error(s.message||"获取验证码失败")}};N(n,s=>{t.phone="",t.password="",t.workId="",t.adminPassword="",t.captcha="",s==="admin"?U():(v.value&&clearInterval(v.value),w.value="",_.value=0)});const h=async()=>{if(e.value)try{await e.value.validate(),p.value=!0;let s;if(n.value==="user")s=await C.userLogin({phone:t.phone,password:t.password,remember:t.remember});else{if(!w.value||_.value<=0){f.warning("请先获取验证码"),await U();return}s=await C.adminLogin({workId:t.workId,adminPassword:t.adminPassword,captcha:t.captcha})}if(s.success)try{localStorage.setItem("token",s.data.token);const r=n.value==="admin"?s.data.admin:s.data.user;if(!r||typeof r!="object")throw new Error("Invalid user information received");localStorage.setItem("userInfo",JSON.stringify(r)),localStorage.setItem("userType",n.value),f.success("登录成功");const V=n.value==="admin"?"/admin":"/user";await o.push(V)}catch(r){console.error("保存用户信息失败:",r),f.error("登录失败：无法保存用户信息"),localStorage.removeItem("token"),localStorage.removeItem("userInfo"),localStorage.removeItem("userType")}else f.error(s.message||"登录失败，请检查账号密码")}catch(s){console.error("登录错误:",s);const r=s.message||"登录失败，请稍后重试";f.error(r)}finally{p.value=!1}},S=localStorage.getItem("rememberedPhone");return S&&(t.phone=S,t.remember=!0),(s,r)=>{const V=m("el-radio-button"),F=m("el-radio-group"),E=m("el-input"),y=m("el-form-item"),R=m("el-checkbox"),$=m("router-link"),T=m("el-button"),b=m("el-form");return P(),x("div",Y,[r[14]||(r[14]=u("div",{class:"bg-shape circle1"},null,-1)),r[15]||(r[15]=u("div",{class:"bg-shape circle2"},null,-1)),r[16]||(r[16]=u("div",{class:"bg-shape triangle"},null,-1)),u("div",ee,[r[13]||(r[13]=u("div",{class:"login-title"},"欢迎登录龙跃智慧停车场",-1)),u("div",re,[a(F,{modelValue:n.value,"onUpdate:modelValue":r[0]||(r[0]=l=>n.value=l),size:"large"},{default:i(()=>[a(V,{value:"user"},{default:i(()=>r[7]||(r[7]=[g("用户登录")])),_:1,__:[7]}),a(V,{value:"admin"},{default:i(()=>r[8]||(r[8]=[g("管理员登录")])),_:1,__:[8]})]),_:1},8,["modelValue"])]),a(b,{ref_key:"loginFormRef",ref:e,model:t,rules:k,class:"login-form",onKeyup:q(h,["enter"])},{default:i(()=>[n.value==="user"?(P(),x(A,{key:0},[a(y,{prop:"phone"},{default:i(()=>[a(E,{modelValue:t.phone,"onUpdate:modelValue":r[1]||(r[1]=l=>t.phone=l),placeholder:"请输入手机号","prefix-icon":"Phone"},null,8,["modelValue"])]),_:1}),a(y,{prop:"password"},{default:i(()=>[a(E,{modelValue:t.password,"onUpdate:modelValue":r[2]||(r[2]=l=>t.password=l),type:"password",placeholder:"请输入密码","prefix-icon":"Lock","show-password":"",onKeyup:q(h,["enter"])},null,8,["modelValue"])]),_:1}),u("div",oe,[a(R,{modelValue:t.remember,"onUpdate:modelValue":r[3]||(r[3]=l=>t.remember=l)},{default:i(()=>r[9]||(r[9]=[g("记住我")])),_:1,__:[9]},8,["modelValue"]),a($,{to:"/forgot-password",class:"forgot-password-link"},{default:i(()=>r[10]||(r[10]=[g("忘记密码？")])),_:1,__:[10]})])],64)):(P(),x(A,{key:1},[a(y,{prop:"workId"},{default:i(()=>[a(E,{modelValue:t.workId,"onUpdate:modelValue":r[4]||(r[4]=l=>t.workId=l),placeholder:"请输入工号","prefix-icon":"User"},null,8,["modelValue"])]),_:1}),a(y,{prop:"adminPassword"},{default:i(()=>[a(E,{modelValue:t.adminPassword,"onUpdate:modelValue":r[5]||(r[5]=l=>t.adminPassword=l),type:"password",placeholder:"请输入密码","prefix-icon":"Lock","show-password":"",onKeyup:q(h,["enter"])},null,8,["modelValue"])]),_:1}),a(y,{prop:"captcha"},{default:i(()=>[a(E,{modelValue:t.captcha,"onUpdate:modelValue":r[6]||(r[6]=l=>t.captcha=l),placeholder:"请输入验证码",onKeyup:q(h,["enter"])},null,8,["modelValue"]),u("div",te,[u("img",{src:w.value,class:"captcha-image",onClick:U,alt:"验证码"},null,8,se)])]),_:1})],64)),a(T,{type:"primary",loading:p.value,class:"login-btn",onClick:Z(h,["prevent"])},{default:i(()=>[g(z(p.value?"登录中...":"登录"),1)]),_:1},8,["loading"]),n.value==="user"?(P(),x("div",ae,[r[12]||(r[12]=g(" 还没有账号？ ")),a($,{to:"/register"},{default:i(()=>r[11]||(r[11]=[g("立即注册")])),_:1,__:[11]})])):B("",!0)]),_:1},8,["model","rules"])])])}}};export{ie as default};
