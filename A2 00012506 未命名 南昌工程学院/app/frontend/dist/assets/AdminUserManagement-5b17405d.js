import{_ as ee,a as E,r as i,H as le,s as ae,b as r,I as te,o as p,c as g,d as A,e as a,f as t,g as oe,D as se,l as B,E as d,h as u,v as ne,M as re,t as v,F as de,J as ue}from"./index-06309a7e.js";import{g as j,a as ie,u as pe,d as me}from"./users-b6f22b71.js";import{a as _e}from"./index-d5848531.js";const fe={class:"user-management-container table-card-gradient"},ce={class:"action-bar"},ge={key:0},ve={key:1},we={key:0},he={key:1},ye={key:0},be={key:1},Ve={__name:"AdminUserManagement",setup(ke){const m=E({current:1,pageSize:10,total:0}),w=i([]),z=i(!1),x=i(""),h=i(!1),y=i(!0),M=i("添加用户"),q=i(!1),C=i(!1),U=i([]),P=i("");le(()=>w.value.length===0?[]:Object.keys(w.value[0]).filter(o=>!["password","password_hash"].includes(o)));const n=E({id:null,name:"",phone:"",email:"",password:"",role:"user"}),F={name:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度2-20个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱格式",trigger:"blur",required:!1}],password:[{required:y.value,message:"请输入密码",trigger:"blur"},{min:6,message:"密码至少6个字符",trigger:"blur",validator:(o,e,s)=>{!y.value&&!e?s():e&&e.length<6?s(new Error("密码至少6个字符")):s()}}],role:[{required:!0,message:"请选择用户角色",trigger:"change"}]},b=async()=>{var o,e;try{z.value=!0,q.value=!1;const s={page:m.current,pageSize:m.pageSize,keyword:x.value},_=await j(s);w.value=((_==null?void 0:_.list)||[]).map(f=>({...f,_showName:!1,_showPhone:!1,_showPwd:!1,_showPwdVal:"******"})),m.total=(_==null?void 0:_.total)||0}catch(s){console.error("获取用户列表错误:",s),q.value=!0,w.value=[],((o=s.response)==null?void 0:o.status)===401?(d.error("登录已过期，请重新登录"),router.push("/login")):((e=s.response)==null?void 0:e.status)===403?d.error("权限不足，请联系管理员"):d.error(`获取用户列表失败: ${s.message||"未知错误"}`)}finally{z.value=!1}},N=()=>{m.current=1,b()},I=()=>{y.value=!0,M.value="添加用户",S(),h.value=!0},K=o=>{y.value=!1,M.value="编辑用户",Object.assign(n,o),n.password="",h.value=!0},O=async()=>{try{if(y.value){if(!n.password){d.error("请填写密码");return}await ie(n),d.success("用户添加成功")}else await pe(n.id,n),d.success("用户更新成功");h.value=!1,S(),b()}catch(o){d.error("操作失败"),console.error(o)}},L=async o=>{try{await me(o),d.success("用户删除成功"),b()}catch(e){d.error("删除用户失败"),console.error(e)}},S=()=>{n.id=null,n.name="",n.phone="",n.email="",n.password=""},T=o=>{"_showPwd"in o||(o._showPwd=!1),o._showPwd=!o._showPwd},H=async()=>{C.value=!0;const o=await j({page:1,pageSize:1e3});w.value=((o==null?void 0:o.list)||[]).map(e=>({...e,_showName:!1,_showPhone:!1,_showPwd:!1,_showPwdVal:"******"}))},J=async()=>{if(!U.value.length||!P.value){d.error("请选择用户并输入内容");return}try{await _e.post("/api/messages/send",{receiver_ids:U.value,content:P.value}),d.success("发送成功"),C.value=!1,U.value=[],P.value=""}catch(o){d.error("发送消息失败"),console.error(o)}};return ae(()=>{b()}),(o,e)=>{const s=r("el-button"),_=r("el-icon"),f=r("el-input"),V=r("el-table-column"),R=r("el-popconfirm"),G=r("el-table"),Q=r("el-pagination"),k=r("el-form-item"),$=r("el-form"),D=r("el-dialog"),W=r("el-option"),X=r("el-select"),Y=te("loading");return p(),g("div",fe,[e[21]||(e[21]=A("h2",null,"用户管理",-1)),A("div",ce,[a(s,{class:"pretty-btn",type:"primary",onClick:I},{default:t(()=>e[13]||(e[13]=[u("添加用户")])),_:1,__:[13]}),a(f,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=l=>x.value=l),placeholder:"搜索用户名或手机号",style:{width:"300px"},onKeyup:oe(N,["enter"])},{append:t(()=>[a(s,{class:"pretty-btn",onClick:N},{default:t(()=>[a(_,null,{default:t(()=>[a(ne(re))]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(s,{class:"pretty-btn",type:"primary",onClick:H},{default:t(()=>e[14]||(e[14]=[u("发送消息")])),_:1,__:[14]})]),se((p(),B(G,{data:w.value,style:{width:"100%"}},{default:t(()=>[a(V,{prop:"id",label:"用户编号","min-width":"100"}),a(V,{label:"用户名","min-width":"120"},{default:t(({row:l})=>{var c;return[l._showName?(p(),g("span",ve,v(l.name),1)):(p(),g("span",ge,v(((c=l.name)==null?void 0:c[0])+"**"),1)),a(s,{type:"text",size:"small",onClick:Z=>l._showName=!l._showName},{default:t(()=>[u(v(l._showName?"隐藏":"显示"),1)]),_:2},1032,["onClick"])]}),_:1}),a(V,{label:"手机号","min-width":"140"},{default:t(({row:l})=>{var c;return[l._showPhone?(p(),g("span",he,v(l.phone),1)):(p(),g("span",we,v(((c=l.phone)==null?void 0:c.slice(0,3))+"****"),1)),a(s,{type:"text",size:"small",onClick:Z=>l._showPhone=!l._showPhone},{default:t(()=>[u(v(l._showPhone?"隐藏":"显示"),1)]),_:2},1032,["onClick"])]}),_:1}),a(V,{prop:"email",label:"邮箱","min-width":"180"}),a(V,{label:"密码","min-width":"120"},{default:t(({row:l})=>[l._showPwd?(p(),g("span",be,v(l._showPwdVal||"******"),1)):(p(),g("span",ye,"******")),a(s,{type:"text",size:"small",onClick:c=>T(l)},{default:t(()=>[u(v(l._showPwd?"隐藏":"显示"),1)]),_:2},1032,["onClick"])]),_:1}),a(V,{label:"操作",width:"180"},{default:t(({row:l})=>[a(s,{class:"pretty-btn",size:"small",onClick:c=>K(l)},{default:t(()=>e[15]||(e[15]=[u("编辑")])),_:2,__:[15]},1032,["onClick"]),a(R,{title:"确定要删除此用户吗？",onConfirm:c=>L(l.id)},{reference:t(()=>[a(s,{class:"pretty-btn",size:"small",type:"danger"},{default:t(()=>e[16]||(e[16]=[u("删除")])),_:1,__:[16]})]),_:2},1032,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[Y,z.value]]),a(Q,{"current-page":m.current,"onUpdate:currentPage":e[1]||(e[1]=l=>m.current=l),"page-size":m.pageSize,"onUpdate:pageSize":e[2]||(e[2]=l=>m.pageSize=l),total:m.total,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:b,onCurrentChange:b},null,8,["current-page","page-size","total"]),a(D,{modelValue:h.value,"onUpdate:modelValue":e[8]||(e[8]=l=>h.value=l),title:M.value,onClosed:S},{footer:t(()=>[a(s,{class:"pretty-btn",onClick:e[7]||(e[7]=l=>h.value=!1)},{default:t(()=>e[17]||(e[17]=[u("取消")])),_:1,__:[17]}),a(s,{class:"pretty-btn",type:"primary",onClick:O},{default:t(()=>e[18]||(e[18]=[u("确认")])),_:1,__:[18]})]),default:t(()=>[a($,{ref:"formRef",model:n,rules:F,"label-width":"80px"},{default:t(()=>[a(k,{label:"用户名",prop:"name",required:""},{default:t(()=>[a(f,{modelValue:n.name,"onUpdate:modelValue":e[3]||(e[3]=l=>n.name=l),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1}),a(k,{label:"手机号",prop:"phone",required:""},{default:t(()=>[a(f,{modelValue:n.phone,"onUpdate:modelValue":e[4]||(e[4]=l=>n.phone=l),placeholder:"请输入手机号"},null,8,["modelValue"])]),_:1}),a(k,{label:"邮箱",prop:"email"},{default:t(()=>[a(f,{modelValue:n.email,"onUpdate:modelValue":e[5]||(e[5]=l=>n.email=l),placeholder:"请输入邮箱（可选）"},null,8,["modelValue"])]),_:1}),a(k,{label:"密码",prop:"password",required:y.value},{default:t(()=>[a(f,{modelValue:n.password,"onUpdate:modelValue":e[6]||(e[6]=l=>n.password=l),placeholder:"请输入密码","show-password":""},null,8,["modelValue"])]),_:1},8,["required"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(D,{modelValue:C.value,"onUpdate:modelValue":e[12]||(e[12]=l=>C.value=l),title:"发送消息",width:"400px"},{footer:t(()=>[a(s,{class:"pretty-btn",onClick:e[11]||(e[11]=l=>C.value=!1)},{default:t(()=>e[19]||(e[19]=[u("取消")])),_:1,__:[19]}),a(s,{class:"pretty-btn",type:"primary",onClick:J},{default:t(()=>e[20]||(e[20]=[u("发送")])),_:1,__:[20]})]),default:t(()=>[a($,null,{default:t(()=>[a(k,{label:"选择用户"},{default:t(()=>[a(X,{modelValue:U.value,"onUpdate:modelValue":e[9]||(e[9]=l=>U.value=l),multiple:"",filterable:"",placeholder:"请选择用户"},{default:t(()=>[(p(!0),g(de,null,ue(w.value,l=>(p(),B(W,{key:l.id,label:l.name||l.phone,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(k,{label:"消息内容"},{default:t(()=>[a(f,{modelValue:P.value,"onUpdate:modelValue":e[10]||(e[10]=l=>P.value=l),type:"textarea",rows:4,placeholder:"请输入消息内容"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},ze=ee(Ve,[["__scopeId","data-v-57921af1"]]);export{ze as default};
